/**
 * 模块加载器
 * @autor alwbg@163.com | soei
 * @Date 2015/4/23
 * @update 2016/1/8 修改低版本的加载问题.
 * @update 2016/4/12 修改获取模块ID问题 短ID和长ID的对称性
 * @update 2016/4/15 整理映射表
 *         1. 修改了获取模版ID的相关逻辑
 *         2. 修改了加载中的模块对应的映射表
 *         3. 修改计算模版ID 计算及存的逻辑, 只做计算不存储
 *         4. 修改只删除AMD模块执行创建的费对象问题
 * 目前支持的
 * - firefox2.0以上(低版本由于不能安装没办验证)
 * - webkit 534版本及以上, 低版本未验证
 * - IE5以上
 * - opera
 * creation-time : 2017-06-22 15:37:41 PM
 */
!function(global){"use strict";function createByTagName(e){return document.createElement(e)}function getTags(e,t){return(t||document).getElementsByTagName(e)}function Module(e,t){this.id=e,this.exports=t,modules[e]=t}function Task(e,t){this.id=e,this.module=t,this.moduleID=t.id,this.wake()}function declareModule(e,t){new Module(e,t),t.id=e,new Task("declare",t).done()}function is(e){if("string"==typeof e){var t=new RegExp("^\\[object "+e+"\\]$");return function(e){return t.test(EMPTY_OBJECT.toString.call(e))}}return function(t){return t instanceof e}}function self(){if(document.currentScript)return document.currentScript;var e,t,r,i,n=getTags("script");try{___I__Will__Error_____()}catch(o){i=o,e=o.stack}if(e&&(e=e.replace(ERR_STACK_REG,$1),r=Qma.getScriptByUri(e,n)))return r;for(t=0;r=n[t++];)if("interactive"===r.readyState)return r;return Qma.getScriptByUri(Qma.currentLoad||i.sourceURL,n)}function merge(e,t,r,i){var n,o,a,s,c;for(c=EMPTY_ARRAY_SLICE.call(arguments),o=c.pop(),c.push(o),/false|true/gi.test(o)||c.push(!1),o=c.pop(),a=c.pop();s=c.shift();)for(n in a)!o&&s.hasOwnProperty&&s.hasOwnProperty(n)||(s[n]=a[n])}function declare(e,t,r){r=r||this;for(var i=e.split("."),n=0;e=i[n++];)if(e in r){if(r=r[e],isSimplyType(r)){debug("%c"+e+" 's type not Object! need Object {} ","color:red");break}}else r=r[e]={};return merge(r,t),r}function each(e,t,r){isFunction(t)&&com.factory[isArray(e)?STRING_ARRAY:STRING_OBJECT].call(r,e,t)}function Util(){}function ModuleWorker(e,t,r){r||(r=e);var i=createByTagName(e.type);each(e.attr,function(e,t){this.setAttribute(e,t)},i),this.argument=[i,t,r],this.onload(e.isScript).onerror(i),HEAD.appendChild(i),debug("%c正在加载模块 -> "+e.uri,"color:#e0e")}function moduleFactory(e){e=com.toRealMI(e);var t;if(t=com.isInModules(e))return t;if(t=com.isInStorage(e)){var r,i=new Module(e,{}),n=t.data();return debug("%c正在创建模块 : "+e,"color:blue"),r=n.length?com.factory.require(t):n.factory.apply(t,[require,i.exports,i]),isFunction(r)?i.exports=r:merge(i.exports,r),i.rebulid(),t.done(),i.exports}}function require(e,t){return isStringNotArray(e)&&void 0===t?moduleFactory(e):(isFunction(e)&&(t=e,e=[]),require.async(e,t))}function define(e,t,r){var i,n=isString(this)?this+EMPTY_STRING:com.pickMI(),o=0;if(isObject(e)||isObject(t)&&++o)return o||(t=e,e=n),e=com.moduleId(e,n),new Task(DEFINE_NAME,new Module(e,t)).done();var a=tools.checkByType(DEFINE_TYPES,[e,t,r],[n,[],function(){}]);e=a[0],t=a[1],r=a[2],r.cmd=!t.length;var s=com.moduleId(e,n);(i=com.isInStorage(s))||(i=new Task(DEFINE_NAME,{id:s,deps:t,factory:r,length:t.length,alias:e})),i.isInActive()&&i.run()}function flush(e){_CallModule(e||_TaskKeys,function(){for(var e,t=[],r={};e=tasks.pop();)if(isTask(e)&&!e.isDone()&&e.isInStorage()&&!(e.module.factory in r))if(r[e.module.factory]=0,e.isReady())tools.runFx(com.factory[e.id],e),e.done();else if(t.push(e),e.id==DEFINE_NAME)break;EMPTY_ARRAY_PUSH.apply(tasks,t)})}function _CallModule(e,t){if(!Qma.isSimplyLoad){if(!e.length)return debug("%c依赖列队加载完毕","color:#3e3"),tools.runFx(t);var r,i=e.shift();if(debug("%c准备加载模块 -> "+i,"color:#666"),r=com.isInStorage(i))r.run();else{if(com.isInLoading(i))return debug("%c已在加载列表 -> "+i,"color:#e06");var n=com.uri.get(i);Qma.currentLoad=n.uri,IS_LONG_LONG_AGO&&(Qma.isSimplyLoad=!0),new ModuleWorker(n,function(e){debug("该标签 : ",e.type,".sheet = ",!!this.argument[0].sheet," : ",e.uri,"color:red"),Qma.isSimplyLoad=!1;var t=e.uri;if(t in _depends){var r=_depends[t]||[],i=r.exports;i&&define.call(t,r.deps,function(){return global[i]})}!com.isInStorage(t)&&define.call(t,{}),flush()})}_CallModule(e,t)}}function debug(){global.DEBUG&&echo.apply(global,EMPTY_ARRAY.slice.call(arguments))}function append(){var e=EMPTY_ARRAY_SLICE.call(arguments).join("");debugBox||(debugBox=document.createElement("div"),debugBox.id="debugBox",document.body.appendChild(debugBox)),CLR||(CLR=/(?:^\%c|color\:(.*)$)/g);var t=document.createElement("div"),r=e.replace(CLR,EMPTY_STRING);r!=e&&(t.style.color=RegExp.$1),t.innerHTML=r,debugBox.appendChild(t),t.setAttribute("debug","true"),debugBox.scrollTop+=t.offsetHeight+10}function echo(){try{Array.apply(null,arguments);throw""}catch(e){try{append(EMPTY_ARRAY_SLICE.call(arguments).join("\r\n\r\n"))}catch(e){}}}var _SELF,MODULE_NAME="deps-name",DEFINE_NAME="define",REQUIRE_NAME="require",STRING_MAIN="main",STRING_OBJECT="object",STRING_ARRAY="array",PATH_NAME="path",EMPTY_STRING="",$1="$1",$1$2="$1$2",EMPTY_ARRAY=[],EMPTY_OBJECT=Object.prototype,EMPTY_ARRAY_PUSH=EMPTY_ARRAY.push,EMPTY_ARRAY_SLICE=EMPTY_ARRAY.slice,DEFINE_TYPES=["String",Array,Function],CONTEXT_PATH=location.pathname.replace(/[^\/]*$/,EMPTY_STRING),USERAGENT=navigator.userAgent,IS_WEBKIT_LOW=USERAGENT.replace(/.*webkit\/([\d]+).*/i,$1)<=534,IS_FIREFOX_LOW=USERAGENT.replace(/.*firefox\/([\d\.]+).*/i,$1)<9;debug(USERAGENT);var IS_LONG_LONG_AGO=IS_WEBKIT_LOW||IS_FIREFOX_LOW,SIGN_REQUIRE=/^function\s*\(\s*([^\),\s]+)/,SIGN_MARK="\\s*\\(\\s*(?:'([^']+)'|\"([^\"]+)\")\\s*\\)",ERR_STACK_REG=/[\D\d]*(?:at|@).*((?:http(?:s|)|file)\:(?:\:(?!\d)|[^\:])*)(?:\:\d*){1,}(?:\)|\r|\n|)$/i,INNER_CLASS_SEP="#",Qma=global._Qma||{},version=Qma.v||EMPTY_STRING,mainJsPath=null,mainJsUri=null,tasks=[],_TaskKeys=[],modules={},loadingMap={},com={},_depends=Qma.depends||{},alias={};com.requireIDs={},merge(alias,Qma.alias),Qma.comp=function(e,t){var r=e.getAttribute(MODULE_NAME);return t=t.split(INNER_CLASS_SEP)[0],r==t||t==e.src},Qma.tmp={getAttribute:function(){return location.host}},Qma.getScriptByUri=function(e,t){for(var r,i=t.length;(r=t[--i])&&(_SELF==r||!this.comp(r,e)););return r||this.tmp},com.moduleStorage={},com.toRealMI=function(e){return com.uri.real(alias[e]||e)},com.isInStorage=function(e){return com.moduleStorage[this.toRealMI(e)]},com.isInLoading=function(e){var e=e.realMI(),t=loadingMap[e];return!t&&(loadingMap[e]=e),t},com.pickMI=function(){return self().getAttribute(MODULE_NAME)},com.moduleId=function(e,t){return e==t&&new RegExp(e+"$").test(t)||(t=t+INNER_CLASS_SEP+e),alias[e]=t.realMI()},com.isInModules=function(e){return modules[e]},com.pull=function(e,t){var r=t.cmd&&SIGN_REQUIRE.test(e)?"|"+RegExp.$1:EMPTY_STRING;return new RegExp("[^a-z](?:"+REQUIRE_NAME+r+")"+SIGN_MARK,"ig")},String.prototype.has=function(e){return isString(e)&&(e=this.indexOf(e)>-1),isRegExp(e)&&(e=e.test(this)),e},String.prototype.realMI=function(){return com.toRealMI(this)};var _Scripts=getTags("script"),HEAD=getTags("head")[0];Module.prototype.rebulid=function(){return modules[this.id]=this.exports,this},merge(Task.prototype,{active:{},storage:com.moduleStorage,echo:echo,each:each,tools:new Util,data:function(){return this.module},wake:function(){return this.storage[this.moduleID]=this,this},stack:function(){return tasks.push(this),this},remove:function(){return this.id==REQUIRE_NAME&&delete this.storage[this.moduleID],this},space:function(){return delete modules[this.moduleID],this.remove()},depend:function(){var e=this.data();return e.alias in _depends&&EMPTY_ARRAY_PUSH.apply(e.deps,(_depends[e.alias]||{}).deps||[]),isFunction(e.factory)&&EMPTY_ARRAY_PUSH.apply(e.deps,tools.getDeps(e.factory)),e.deps||[]},isInActive:function(){return this.moduleID in this.active},run:function(){if(this.isDone())return this;var e=this.depend();return each(e,function(e,t){this[t.realMI()]=!0},this.active),debug("%c检索模块依赖 -> "+this.moduleID+" : ["+e+"] \r\n","color:#070"),EMPTY_ARRAY_PUSH.apply(_TaskKeys,e),this.stack(),flush(),this},done:function(){return this.loaded=!0,this},isDone:function(){return this.loaded},isInStorage:function(){return this.moduleID in this.storage},isReady:function(){for(var e,t=this.data().deps,r=t.length;e=t[--r];)if(!com.isInStorage(e))return debug("%c所依赖的模块["+e+"] [未加载完成]","color:#777"),!1;return!0}});var isRoot=is("Object"),isObject=function(e){return e&&isRoot(e)},isFunction=is("Function"),isArray=is("Array"),isString=is("String"),isRegExp=is(RegExp),isTask=is(Task),isSimplyType=is("(?:Number|Boolean|Null|String|Undefined)"),isStringOrArray=is("(?:Array|String)"),isStringNotArray=is("(?:(?!Array)|String)");declare("alias",{},Qma),declare("types",{},Qma),declare("pick",{},Qma),com.factory={array:function(e,t,r,i){for(r=0,i=e.length;i>r&&!t.call(this,r,e[r],e);r++);},object:function(e,t,r){for(r in e)if(t.call(this,r,e[r],e))break},push:function(e,t,r){return e.push(r)},add:function(e,t,r){e[t]=r}};var tools=new Util,FORMAT_FUNC=declare("format.function",{SEP:"{@}",START:"{%}",LEFT:"{",RIGHT:"}",map:{},NUM:1e6,_ONLY_REQUIRE:/(require\s*\([^\),]*,\s*function\s*\([^\)]*\)\s*\{)/,REQUIRE:/(?:(require\s*\([^\),]*,\s*function\s*\([^\)]*\)\s*\{)|(\{)|(\}))/g,REPLACE:function(e){return this.map[e]||(this.map[e]=new RegExp("\\"+this.START+e+"(?:(?!\\"+this.SEP+e+").|\\n)*\\"+this.SEP+e))}},com),moduleIDs={};merge(Util.prototype,{ANNOTATION_REG:/(?:(\/\*+(?:[^*]|\*[^\/])*\*\/))|(?:([^\/'":])\/\/.*$)[\r\n]*/gm,runFx:function(e,t){var r=EMPTY_ARRAY_SLICE.call(arguments),i=r.shift();return i instanceof Function?i.apply(this,r):void 0},getDeps:function(e){var t=e.toString();t=t.replace(this.ANNOTATION_REG,EMPTY_STRING),FORMAT_FUNC._ONLY_REQUIRE.test(t)&&(t=this.removeAsyncRequire(t));var r={mark:com.pull(t,e),pick:[],map:com.requireIDs};return each(t.match(r.mark)||[],function(e,t){t=t.replace(this.mark,$1$2),t in this.map||(this.map[t]=!0,this.pick.push(t))},r),r.pick},removeAsyncRequire:function(e){var t=FORMAT_FUNC.LEFT,r=FORMAT_FUNC.RIGHT,i=FORMAT_FUNC.SEP,n=FORMAT_FUNC.START,o=!1,a=0,s=FORMAT_FUNC.NUM;for(e=e.replace(FORMAT_FUNC.REQUIRE,function(e,c){return c?(s=1,a++,o=!0,n):o&&(e==t&&s++,e==r&&s--,0==s)?(o=!1,s=FORMAT_FUNC.NUM,i):EMPTY_STRING});-1!=e.indexOf(n)&&a--;)e=e.replace(FORMAT_FUNC.REPLACE(EMPTY_STRING),EMPTY_STRING);return e},checkByType:function(e,t,r){if(!isArray(t))return n;r||(r=[]);for(var i,n=[],o=0,a=e.length;(i=t.shift())||a>o;)is(e[o])(i)?n.push(i):(i&&t.unshift(i),n.push(r[o])),o++;return n},pick:function(e,t,r){if(!isArray(t))return e;var i,n=r||{},o=com.factory[isArray(r)?"push":"add"];return each(t,function(t,r){i=r in e,i&&this.fx(this.box,r,e[r])},{box:n,fx:o}),n},toArray:function(e){return EMPTY_ARRAY_SLICE.call(e)},merge:merge}),_SELF=self(),tools.config={JS:".js",CSS:".css",".js":"script",".css":"link",data:{link:{type:"text/css",rel:"stylesheet"}},src:{link:"href",script:"src"},info:function(e){return"%cError: at ["+e+"] Modules do not exist or load timed out!"}},merge(ModuleWorker.prototype,{onload:function(e){return this[IS_LONG_LONG_AGO&&!e?"load":"moduleLoad"].apply(this,this.argument),this},onerror:function(e){var t=this;return e.onerror=function(){t.task&&t.task.space(),debug(tools.config.info(t.attr.src),"color:red")},this},load:function(e,t,r){var i=0,n=this;debug("进入低版本样式加载模式 > ",e.href,"color:#9bd807");var o=100,a=15e3;!function s(){return e.sheet||i>a?t.call(n,r):(i+=o,void setTimeout(s,o))}()},moduleLoad:"onreadystatechange"in _SELF?function(e,t,r){var i=this;e.onreadystatechange=function(e){/^(?:complete|loaded)$/.test(this.readyState)&&tools.runFx.call(i,t,r)}}:function(e,t,r){var i=this;e.onload=function(e){tools.runFx.call(i,t,r)}}}),require.async=function(e,t){isString(e)&&(e=[e.realMI()]);var r=e.length,i=new Task(REQUIRE_NAME,{id:isString(this)?this:REQUIRE_NAME+ +new Date,deps:e,length:r,factory:t});for(i.async=!!r;r--&&com.isInModules(e[r]););0>r?com.factory.require(i):i.run()},require.use=require.async,declare("factory",{require:function(e){var t=e.data(),r=t.deps.slice(0,t.length);return each(r,function(e,t){this[e]=moduleFactory(t)},r),r.unshift(t.factory),tools.runFx.apply(e.remove(),r)}},com),declare("uri",{DOT_EXTNAME:/\.(js(?=$|#))/,HAS_EXT:/(?:(\.(?:css|js))|(.))(\?|\#|$)/,DOT:/(?:[^\/]*\/[^\/]*\.{2}\/|\/\.(?!\.))/,get:function(e){var t=Qma.types[e];t||(e=e.split(INNER_CLASS_SEP)[0]);var r=this.extname(e).toLowerCase(),i=this.path(/^(?:http[s]?|file)\:/.test(e)?e:e.realMI(),r),n={uri:e,type:tools.config[r],attr:{async:!0},suffix:r};return n.isScript=r==tools.config.JS,n.attr[MODULE_NAME]=n.uri,n.attr[tools.config.src[n.type]]=i,merge(n.attr,tools.config.data[n.type]),n},real:function(e){if(this.DOT.test(e))for(e=CONTEXT_PATH+e;this.DOT.test(e);)e=e.replace(this.DOT,EMPTY_STRING);return e.replace(this.DOT_EXTNAME,EMPTY_STRING)},extname:function(e){var t=com.toRealMI(e),r=Qma.types[e];return r||(this.HAS_EXT.test(t),r=RegExp.$1 in tools.config?RegExp.$1:tools.config.JS),debug(t,">",this.HAS_EXT.test(t)," : |",r,"|","color:#07afd8"),r},path:function(e,t){var r=/\?|#/.test(e)?"&":"?";return e=e.replace(this.HAS_EXT,"$2"+t+"$3"),e+r+version}},com),merge(global,{define:define,require:require,modules:modules},!0),mainJsPath=_SELF.getAttribute(STRING_MAIN),mainJsPath?require.async(mainJsPath):(mainJsPath=_SELF.innerHTML)&&eval(mainJsPath),declareModule("_tools__",tools.pick(tools,["runFx","checkByType","pick"])),declareModule(REQUIRE_NAME,require),global.DEBUG=global.DEBUG||!1,global.appendChild=append;var debugBox,CLR;Qma.com=com,Qma.each=each,Qma.debug=Qma.debug||debug,Qma.echo=echo,Qma.append=append}(window);