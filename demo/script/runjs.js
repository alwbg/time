/**
 * 模块加载器
 * @autor alwbg@163.com | soei
 *  ------------------------------------
 *  -  https://github.com/alwbg/runJs  -
 *  ------------------------------------
 * @Date 2015/4/23
 * @update 2016/1/8 修改低版本的加载问题.
 * @update 2016/4/12 修改获取模块ID问题 短ID和长ID的对称性
 * @update 2016/4/15 整理映射表
 *         1. 修改了获取模版ID的相关逻辑
 *         2. 修改了加载中的模块对应的映射表
 *         3. 修改计算模版ID 计算及存的逻辑, 只做计算不存储
 *         4. 修改只删除AMD模块执行创建的费对象问题
 * @update 2017/6/23 新增对HTML内的runJs代码块的支持
 *         <!--其中先执行代码块内的代码,再执行main模块的代码-->
 *         <script src="runjs.js" main="main" >
 *         		//module-name = "__runjs.inner__"
 *         		var $ = require( 'query' );
 *         		$( 'test' ).appendTo( 'body' );
 *         		//exports 为方法块内部对象
 *         		exports.run = function(){
 *         		}
 *         		//为模块间传递参数
 *         		return {
 *         			language : {zh:{},en:{}}
 *         		}
 *         </script>
 * @update 2017/7/5 22:30 修改 _async_require_map._async_fx__ 对ES6 function新语法支持
 * 目前支持的
 * - firefox2.0以上(低版本由于不能安装没办验证)
 * - webkit 534版本及以上, 低版本未验证
 * - IE5以上
 * - opera
 * creation-time : 2017-07-06 15:58:46 PM
 */
!function(t){"use strict";function e(t){return document.createElement(t)}function r(t,e){return(e||document).getElementsByTagName(t)}function n(t,e){this.id=t,this.exports=e,X[t]=e}function i(t,e){this.id=t,this.module=e,this.moduleID=e.id,this.wake()}function o(t,e){new n(t,e),e.id=t,new i("declare",e).done()}function s(t){if("string"==typeof t){var e=new RegExp("^\\[object "+t+"\\]$");return function(t){return e.test(b.toString.call(t))}}return function(e){return e instanceof t}}function a(){if(document.currentScript)return document.currentScript;var t,e,n,i,o=r("script");try{___I__Will__Error_____()}catch(e){i=e,t=e.stack}if(t&&(t=t.replace(B,k),n=U.getScriptByUri(t,o)))return n;for(e=0;n=o[e++];)if("interactive"===n.readyState)return n;return U.getScriptByUri(U.currentLoad||i.sourceURL,o)}function u(t,e,r,n){var i,o,s,a,u;for(o=(u=D.call(arguments)).pop(),u.push(o),/false|true/gi.test(o)||u.push(!1),o=u.pop(),s=u.pop();a=u.shift();)for(i in s)!o&&a.hasOwnProperty&&a.hasOwnProperty(i)||(a[i]=s[i])}function c(t,e,r){r=r||this;for(var n=t.split("."),i=0;t=n[i++];)if(t in r){if(r=r[t],nt(r)){_("%c"+t+" 's type not Object! need Object {} ","color:red");break}}else r=r[t]={};return u(r,e),r}function l(t,e,r){Y(e)&&z.factory[Z(t)?R:T].call(r,t,e)}function f(){}function p(t,r,n){n||(n=t);var i=e(t.type);l(t.attr,function(t,e){this.setAttribute(t,e)},i),this.argument=[i,r,n],this.onload(t.isScript).onerror(i),K.appendChild(i),_("%c正在加载模块 -> "+t.uri,"color:#e0e")}function d(t){t=z.toRealMI(t);var e;if(e=z.isInModules(t))return e;if(e=z.isInStorage(t)){var r,i=new n(t,{}),o=e.data();return _("%c正在创建模块 : "+t,"color:blue"),r=o.length?z.factory.require(e):o.factory.apply(e,[h,i.exports,i,t]),Y(r)?i.exports=r:u(i.exports,r),i.rebulid(),e.done(),i.exports}}function h(t,e){return ot(t)&&void 0===e?d(t):(Y(t)&&(e=t,t=[]),h.async(t,e))}function y(t,e,r){var o,s=tt(this)?this+A:z.pickMI(),a=0;if(it(t)||it(e)&&++a)return a||(e=t,t=s),t=z.moduleId(t,s),new i(E,new n(t,e)).done();var u=st.checkByType($,[t,e,r],[s,[],function(){}]);t=u[0],e=u[1],(r=u[2]).cmd=!e.length;var c=z.moduleId(t,s);(o=z.isInStorage(c))||(o=new i(E,{id:c,deps:e,factory:r,length:e.length,alias:t})),o.isInActive()&&o.run()}function g(t){m(t||G,function(){for(var t,e=[],r={};t=P.pop();)if(rt(t)&&!t.isDone()&&t.isInStorage()&&!(t.module.factory in r))if(r[t.module.factory]=0,t.isReady())st.runFx(z.factory[t.id],t),t.done();else if(e.push(t),t.id==E)break;w.apply(P,e)})}function m(e,r){if(!U.isSimplyLoad){if(!e.length)return _("%c依赖列队加载完毕","color:#3e3"),st.runFx(r);var n,i=e.shift();if(_("%c准备加载模块 -> "+i,"color:#666"),n=z.isInStorage(i))n.run();else{if(z.isInLoading(i))return _("%c已在加载列表 -> "+i,"color:#e06");var o=z.uri.get(i);U.currentLoad=o.uri,N&&(U.isSimplyLoad=!0),new p(o,function(e){_("该标签 : ",e.type,".sheet = ",!!this.argument[0].sheet," : ",e.uri,"color:red"),U.isSimplyLoad=!1;var r=e.uri;if(r in Q){var n=Q[r]||[],i=n.exports;i&&y.call(r,n.deps,function(){return t[i]})}!z.isInStorage(r)&&y.call(r,{}),g()})}m(e,r)}}function v(){C&&h.async(C)}function _(){t.DEBUG&&I.apply(t,M.slice.call(arguments))}function S(){var t=D.call(arguments).join("");ut||((ut=document.createElement("div")).id="debugBox",document.body.appendChild(ut)),ct||(ct=/(?:^\%c|color\:(.*)$)/g);var e=document.createElement("div"),r=t.replace(ct,A);r!=t&&(e.style.color=RegExp.$1),e.innerHTML=r,ut.appendChild(e),e.setAttribute("debug","true"),ut.scrollTop+=e.offsetHeight+10}function I(){try{var t=Array.apply(null,arguments);console.log.apply(console,t)}catch(t){try{S(D.call(arguments).join("\r\n\r\n"))}catch(t){}}}var x,E="define",T="object",R="array",A="",k="$1",M=[],b=Object.prototype,w=M.push,D=M.slice,$=["String",Array,Function],q=location.pathname.replace(/[^\/]*$/,A),L=navigator.userAgent,O=L.replace(/.*webkit\/([\d]+).*/i,k)<=534,j=L.replace(/.*firefox\/([\d\.]+).*/i,k)<9;_(L);var N=O||j,F=/^[^(]*\(\s*([^\),\s]+)(?:=>)?/,B=/[\D\d]*(?:at|@).*((?:http(?:s|)|file)\:(?:\:(?!\d)|[^\:])*)(?:\:\d*){1,}(?:\)|\r|\n|)$/i,U=t._Qma||{},H=U.v||A,C=null,P=[],G=[],X={},J={},z={},Q=U.depends||{},W={};z.requireIDs={},u(W,U.alias),U.comp=function(t,e){var r=t.getAttribute("deps-name");return e=e.split("#")[0],r==e||e==t.src},U.tmp={getAttribute:function(){return location.host}},U.getScriptByUri=function(t,e){for(var r,n=e.length;(r=e[--n])&&(x==r||!this.comp(r,t)););return r||this.tmp},z.moduleStorage={},z.toRealMI=function(t){return z.uri.real(W[t]||t)},z.isInStorage=function(t){return z.moduleStorage[this.toRealMI(t)]},z.isInLoading=function(t){var t=t.realMI(),e=J[t];return!e&&(J[t]=t),e},z.pickMI=function(){return a().getAttribute("deps-name")},z.moduleIdRMap={},z.moduleId=function(t,e){return(this.moduleIdRMap[t]||(this.moduleIdRMap[t]=new RegExp(t+"(?:$|\\.js)","i"))).test(e)||(e=e+"#"+t),W[t]=(e||t).realMI()},z.isInModules=function(t){return X[t]},z.pull=function(t,e){var r,n=e.cmd&&F.test(t)&&(r=RegExp.$1)&&"require"!=r?"|"+RegExp.$1:A;return new RegExp("[^a-z](?:require"+n+")\\s*\\(\\s*(?:'([^']+)'|\"([^\"]+)\")\\s*\\)","ig")},String.prototype.has=function(t){return tt(t)&&(t=this.indexOf(t)>-1),et(t)&&(t=t.test(this)),t},String.prototype.realMI=function(){return z.toRealMI(this)};r("script");var K=r("head")[0];n.prototype.rebulid=function(){return X[this.id]=this.exports,this},u(i.prototype,{active:{},storage:z.moduleStorage,echo:I,each:l,tools:new f,data:function(){return this.module},wake:function(){return this.storage[this.moduleID]=this,this},stack:function(){return P.push(this),this},remove:function(){return"require"==this.id&&delete this.storage[this.moduleID],this},space:function(){return delete X[this.moduleID],this.remove()},depend:function(){var t=this.data();return t.alias in Q&&w.apply(t.deps,(Q[t.alias]||{}).deps||[]),Y(t.factory)&&w.apply(t.deps,st.getDeps(t.factory)),t.deps||[]},isInActive:function(){return this.moduleID in this.active},run:function(){if(this.isDone())return this;var t=this.depend();return l(t,function(t,e){this[e.realMI()]=!0},this.active),_("%c检索模块依赖 -> "+this.moduleID+" : ["+t+"] \r\n","color:#070"),w.apply(G,t),this.stack(),g(),this},done:function(){return this.loaded=!0,this},isDone:function(){return this.loaded},isInStorage:function(){return this.moduleID in this.storage},isReady:function(){for(var t,e=this.data().deps,r=e.length;t=e[--r];)if(!z.isInStorage(t))return _("%c所依赖的模块["+t+"] [未加载完成]","color:#777"),!1;return!0},require:h});var V=s("Object"),Y=s("Function"),Z=s("Array"),tt=s("String"),et=s(RegExp),rt=s(i),nt=s("(?:Number|Boolean|Null|String|Undefined)"),it=function(t){return t&&V(t)},ot=s("(?:(?!Array)|String)");c("alias",{},U),c("types",{},U),c("pick",{},U),z.factory={array:function(t,e,r,n){for(r=0,n=t.length>>0;r<n&&!e.call(this,r,t[r],t);r++);},object:function(t,e,r){for(r in t)if(e.call(this,r,t[r],t))break},push:function(t,e,r){return t.push(r)},add:function(t,e,r){t[e]=r}};var st=new f,at={SEP:"{@}",START:"{%}",LEFT:"{",RIGHT:"}",map:{},NUM:1e6,_has_async_func_:/(?:require|\w+)\s*\([^),]*/,_async_fx__:/(?:((?:require|\w+)\s*\([^),]*,[^(]*\([^)]*\)\s*(?:=>)?\s*\{)|(\{)|(\}))/g,REPLACE:function(t){return this.map[t]||(this.map[t]=new RegExp("\\"+this.START+t+"(?:(?!\\"+this.SEP+t+").|\\n)*\\"+this.SEP+t))}};if(u(f.prototype,{ANNOTATION_REG:/(?:(\/\*+(?:[^*]|\*[^\/])*\*\/))|(?:([^\/'":])\/\/.*$)[\r\n]*/gm,runFx:function(t,e){var r=D.call(arguments),n=r.shift();if(n instanceof Function)return n.apply(this,r)},getDeps:function(t){var e=t.toString();e=e.replace(this.ANNOTATION_REG,A),at._has_async_func_.test(e)&&(e=this.removeAsyncRequire(e));var r={mark:z.pull(e,t),pick:[],map:z.requireIDs};return l(e.match(r.mark)||[],function(t,e){(e=e.replace(this.mark,"$1$2"))in this.map||(this.map[e]=!0,this.pick.push(e))},r),r.pick},removeAsyncRequire:function(t){var e=at.LEFT,r=at.RIGHT,n=at.SEP,i=at.START,o=!1,s=0,a=at.NUM;for(t=t.replace(at._async_fx__,function(t,u){return u?(a=1,s++,o=!0,i):o&&(t==e&&a++,t==r&&a--,0==a)?(o=!1,a=at.NUM,n):A});-1!=t.indexOf(i)&&s--;)t=t.replace(at.REPLACE(A),A);return t},checkByType:function(t,e,r){if(!Z(e))return i;r||(r=[]);for(var n,i=[],o=0,a=t.length;(n=e.shift())||o<a;)s(t[o])(n)?i.push(n):(n&&e.unshift(n),i.push(r[o])),o++;return i},pick:function(t,e,r){if(!Z(e))return t;var n,i=r||{};return l(e,function(e,r){(n=r in t)&&this.fx(this.box,r,t[r])},{box:i,fx:z.factory[Z(r)?"push":"add"]}),i},toArray:function(t){return D.call(t)},merge:u}),x=a(),st.config={JS:".js",CSS:".css",".js":"script",".css":"link",data:{link:{type:"text/css",rel:"stylesheet"}},src:{link:"href",script:"src"},info:function(t){return"%cError: at ["+t+"] Modules do not exist or load timed out!"}},u(p.prototype,{onload:function(t){return this[N&&!t?"load":"moduleLoad"].apply(this,this.argument),this},onerror:function(t){var e=this;return t.onerror=function(){e.task&&e.task.space(),_(st.config.info(e.attr.src),"color:red")},this},load:function(t,e,r){var n=0,i=this;_("进入低版本样式加载模式 > ",t.href,"color:#9bd807");!function o(){if(t.sheet||n>15e3)return e.call(i,r);n+=100,setTimeout(o,100)}()},moduleLoad:"onreadystatechange"in x?function(t,e,r){var n=this;t.onreadystatechange=function(t){/^(?:complete|loaded)$/.test(this.readyState)&&st.runFx.call(n,e,r)}}:function(t,e,r){var n=this;t.onload=function(t){st.runFx.call(n,e,r)}}}),h.async=function(t,e){tt(t)&&(t=[t.realMI()]);var r=t.length,n=new i("require",{id:tt(this)?this:"require"+ +new Date,deps:t,length:r,factory:e});for(Y(e)&&(e.cmd=!1),n.async=!!r;r--&&z.isInModules(t[r]););r<0?z.factory.require(n):n.run()},h.use=h.async,c("factory",{require:function(t){var e=t.data(),r=e.deps.slice(0,e.length);return l(r,function(t,e){this[t]=d(e)},r),r.unshift(e.factory),st.runFx.apply(t.remove(),r)}},z),c("uri",{DOT_EXTNAME:/\.(js(?=$|#))/,HAS_EXT:/(?:(\.(?:css|js))|(.))(\?|\#|$)/,DOT:/(?:[^\/]*\/[^\/]*\.{2}\/|\/\.(?!\.))/,get:function(t){U.types[t]||(t=t.split("#")[0]);var e=this.extname(t).toLowerCase(),r=this.path(/^(?:http[s]?|file)\:/.test(t)?t:t.realMI(),e),n={uri:t,type:st.config[e],attr:{async:!0},suffix:e};return n.isScript=e==st.config.JS,n.attr["deps-name"]=n.uri,n.attr[st.config.src[n.type]]=r,u(n.attr,st.config.data[n.type]),n},real:function(t){if(this.DOT.test(t))for(t=q+t;this.DOT.test(t);)t=t.replace(this.DOT,A);return t.replace(this.DOT_EXTNAME,A)},extname:function(t){var e=z.toRealMI(t),r=U.types[t];return r||(this.HAS_EXT.test(e),r=RegExp.$1 in st.config?RegExp.$1:st.config.JS),_(e,">",this.HAS_EXT.test(e)," : |",r,"|","color:#07afd8"),r},path:function(t,e){var r=/\?|#/.test(t)?"&":"?";return(t=t.replace(this.HAS_EXT,"$2"+e+"$3"))+(H&&r+H)||A}},z),u(t,{define:y,require:h,modules:X},!1),o("require",h),o("_tools__",st.pick(st,["runFx","checkByType","pick"])),y.toString=h.toString=function(){return"function(){[native code]}"},C=x.getAttribute("main"),x.innerHTML){y.call("__runjs.inner__",new Function("require","exports","module","__module_name",x.innerHTML)),h("__runjs.inner__",function(){v(),g()})}else v();t.DEBUG=t.DEBUG||!1,t.appendChild=S;var ut,ct}(window);